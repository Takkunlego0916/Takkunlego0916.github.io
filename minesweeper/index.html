<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Minesweeper</title>
<style>
  :root{
    --bg:#0f1724; --panel:#0b1220; --accent:#ffcc00; --text:#e6eef8;
    --cell:#1b2636; --cell-open:#cfe8ff;
  }
  html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif;background:linear-gradient(180deg,#071021 0%,#0b1220 100%);color:var(--text)}
  .wrap{min-height:100%;display:flex;align-items:center;justify-content:center;padding:28px;box-sizing:border-box}
  .panel{background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);padding:18px;border-radius:12px;box-shadow:0 8px 30px rgba(2,6,23,0.6);width:100%;max-width:760px}
  .header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:12px}
  .title{font-weight:700;font-size:20px;display:flex;gap:10px;align-items:center}
  .controls{display:flex;gap:8px;align-items:center}
  select,button{background:var(--panel);color:var(--text);border:1px solid rgba(255,255,255,0.04);padding:8px 10px;border-radius:8px}
  .status{display:flex;gap:12px;align-items:center}
  .badge{background:#071a2b;padding:6px 10px;border-radius:8px;font-weight:600}
  .board-wrap{display:flex;flex-direction:column;gap:12px;align-items:center}
  .board{display:grid;gap:4px;background:transparent;padding:8px;border-radius:8px}
  .cell{width:36px;height:36px;background:var(--cell);border-radius:6px;display:flex;align-items:center;justify-content:center;color:var(--text);font-weight:700;user-select:none;cursor:pointer;box-shadow:inset 0 -2px 0 rgba(0,0,0,0.25)}
  .cell.open{background:var(--cell-open);color:#0b1220;cursor:default;box-shadow:none}
  .cell.flag{background:#2b3b4b;color:#ff6666}
  .cell.mine{background:#ff6666;color:#fff}
  .controls small{color:#9fb0d6}
  .footer{margin-top:12px;color:#9fb0d6;font-size:13px;text-align:center}
  @media (max-width:520px){
    .cell{width:30px;height:30px;font-size:14px}
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="panel" role="application" aria-label="Minesweeper game">
    <div class="header">
      <div class="title">Minesweeper</div>
      <div class="controls">
        <label for="difficulty" style="display:flex;flex-direction:column;align-items:flex-end">
          <small style="color:#9fb0d6">Èõ£ÊòìÂ∫¶</small>
          <select id="difficulty" aria-label="Èõ£ÊòìÂ∫¶ÈÅ∏Êäû">
            <option value="easy">Easy 9√ó9 10Âú∞Èõ∑</option>
            <option value="medium" selected>Medium 16√ó16 40Âú∞Èõ∑</option>
            <option value="hard">Hard 30√ó16 99Âú∞Èõ∑</option>
          </select>
        </label>
        <button id="newBtn">New</button>
      </div>
    </div>

    <div class="status" style="margin-bottom:8px">
      <div class="badge">ÊÆã„ÇäÊóó: <span id="flags">0</span></div>
      <div class="badge">ÊôÇÈñì: <span id="timer">0</span>s</div>
      <div id="message" style="min-width:120px;text-align:center;font-weight:700"></div>
    </div>

    <div class="board-wrap">
      <div id="board" class="board" role="grid" aria-label="„Ç≤„Éº„É†Áõ§"></div>
    </div>

    <div class="footer">Â∑¶„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñã„Åè Âè≥„ÇØ„É™„ÉÉ„ÇØ„ÅßÊóó„ÇíÁ´ã„Å¶„ÇãÔºà„É¢„Éê„Ç§„É´„ÅØÈï∑Êäº„Åó„ÅßÊóóÔºâ</div>
  </div>
</div>

<script>
(() => {
  const boardEl = document.getElementById('board');
  const difficultyEl = document.getElementById('difficulty');
  const newBtn = document.getElementById('newBtn');
  const flagsEl = document.getElementById('flags');
  const timerEl = document.getElementById('timer');
  const messageEl = document.getElementById('message');

  let cols = 16, rows = 16, minesCount = 40;
  let grid = [], started = false, timer = null, seconds = 0, flagsLeft = 0, cellsLeft = 0, gameOver = false;

  function setDifficulty(v){
    if(v==='easy'){cols=9;rows=9;minesCount=10}
    else if(v==='medium'){cols=16;rows=16;minesCount=40}
    else {cols=30;rows=16;minesCount=99}
  }

  function createBoard(){
    boardEl.innerHTML = '';
    boardEl.style.gridTemplateColumns = `repeat(${cols}, auto)`;
    grid = [];
    started = false; clearInterval(timer); timer = null; seconds = 0; timerEl.textContent = '0'; messageEl.textContent = '';
    flagsLeft = minesCount; flagsEl.textContent = flagsLeft;
    gameOver = false;

    // initialize cells
    for(let r=0;r<rows;r++){
      const row = [];
      for(let c=0;c<cols;c++){
        const cell = {r,c,mine:false,open:false,flag:false,adj:0,el:null};
        const el = document.createElement('div');
        el.className = 'cell';
        el.dataset.r = r; el.dataset.c = c;
        el.addEventListener('click', onCellClick);
        el.addEventListener('contextmenu', onCellRightClick);
        // mobile long press for flag
        let pressTimer = null;
        el.addEventListener('touchstart', e => {
          pressTimer = setTimeout(()=>{ toggleFlag(cell); }, 600);
        }, {passive:true});
        el.addEventListener('touchend', e => { if(pressTimer) clearTimeout(pressTimer); }, {passive:true});
        cell.el = el;
        boardEl.appendChild(el);
        row.push(cell);
      }
      grid.push(row);
    }
    cellsLeft = cols*rows - minesCount;
  }

  function placeMines(firstR, firstC){
    // place mines avoiding first click and neighbors
    const forbidden = new Set();
    for(let dr=-1;dr<=1;dr++) for(let dc=-1;dc<=1;dc++){
      const nr = firstR+dr, nc = firstC+dc;
      if(nr>=0 && nr<rows && nc>=0 && nc<cols) forbidden.add(nr+','+nc);
    }
    let placed = 0;
    while(placed < minesCount){
      const r = Math.floor(Math.random()*rows);
      const c = Math.floor(Math.random()*cols);
      const key = r+','+c;
      if(forbidden.has(key)) continue;
      const cell = grid[r][c];
      if(cell.mine) continue;
      cell.mine = true; placed++;
    }
    // compute adjacents
    for(let r=0;r<rows;r++) for(let c=0;c<cols;c++){
      let count = 0;
      for(let dr=-1;dr<=1;dr++) for(let dc=-1;dc<=1;dc++){
        if(dr===0 && dc===0) continue;
        const nr=r+dr, nc=c+dc;
        if(nr>=0 && nr<rows && nc>=0 && nc<cols && grid[nr][nc].mine) count++;
      }
      grid[r][c].adj = count;
    }
  }

  function startTimer(){
    if(timer) return;
    timer = setInterval(()=>{ seconds++; timerEl.textContent = seconds; }, 1000);
  }

  function reveal(cell){
    if(cell.open || cell.flag || gameOver) return;
    cell.open = true;
    cell.el.classList.add('open');
    if(cell.mine){
      cell.el.classList.add('mine');
      cell.el.textContent = 'üí£';
      lose();
      return;
    }
    cellsLeft--;
    if(cell.adj>0){
      cell.el.textContent = cell.adj;
      cell.el.style.color = colorForNumber(cell.adj);
    } else {
      // empty, flood fill
      for(let dr=-1;dr<=1;dr++) for(let dc=-1;dc<=1;dc++){
        const nr = cell.r+dr, nc = cell.c+dc;
        if(nr>=0 && nr<rows && nc>=0 && nc<cols) reveal(grid[nr][nc]);
      }
    }
    checkWin();
  }

  function colorForNumber(n){
    const map = {1:'#0000ff',2:'#007700',3:'#ff0000',4:'#000088',5:'#880000',6:'#008888',7:'#000',8:'#888'};
    return map[n] || '#000';
  }

  function onCellClick(e){
    const r = +this.dataset.r, c = +this.dataset.c;
    const cell = grid[r][c];
    if(gameOver) return;
    if(!started){
      placeMines(r,c);
      started = true;
      startTimer();
    }
    reveal(cell);
  }

  function onCellRightClick(e){
    e.preventDefault();
    const r = +this.dataset.r, c = +this.dataset.c;
    const cell = grid[r][c];
    toggleFlag(cell);
  }

  function toggleFlag(cell){
    if(cell.open || gameOver) return;
    cell.flag = !cell.flag;
    if(cell.flag){
      cell.el.classList.add('flag');
      cell.el.textContent = 'üö©';
      flagsLeft--;
    } else {
      cell.el.classList.remove('flag');
      cell.el.textContent = '';
      flagsLeft++;
    }
    flagsEl.textContent = flagsLeft;
  }

  function lose(){
    gameOver = true;
    clearInterval(timer); timer = null;
    messageEl.textContent = 'You Lose';
    // reveal all mines
    for(let r=0;r<rows;r++) for(let c=0;c<cols;c++){
      const cell = grid[r][c];
      if(cell.mine && !cell.open){
        cell.el.classList.add('open','mine');
        cell.el.textContent = 'üí£';
      }
    }
  }

  function checkWin(){
    if(cellsLeft === 0 && !gameOver){
      gameOver = true;
      clearInterval(timer); timer = null;
      messageEl.textContent = 'You Win';
      // mark remaining mines with flag
      for(let r=0;r<rows;r++) for(let c=0;c<cols;c++){
        const cell = grid[r][c];
        if(cell.mine){
          cell.el.classList.add('flag');
          cell.el.textContent = 'üö©';
        }
      }
    }
  }

  // new game handler
  newBtn.addEventListener('click', ()=> {
    setDifficulty(difficultyEl.value);
    createBoard();
  });

  difficultyEl.addEventListener('change', ()=> {
    setDifficulty(difficultyEl.value);
    createBoard();
  });

  // initialize
  setDifficulty(difficultyEl.value);
  createBoard();

  // accessibility: keyboard support (Enter to open, F to flag)
  boardEl.addEventListener('keydown', (e) => {
    const target = e.target;
    if(!target.classList.contains('cell')) return;
    const r = +target.dataset.r, c = +target.dataset.c;
    const cell = grid[r][c];
    if(e.key === 'Enter') reveal(cell);
    if(e.key.toLowerCase() === 'f') toggleFlag(cell);
  });

  // focus first cell for keyboard users
  setTimeout(()=> {
    const first = boardEl.querySelector('.cell');
    if(first) first.tabIndex = 0;
  }, 200);

})();
</script>
</body>
</html>
